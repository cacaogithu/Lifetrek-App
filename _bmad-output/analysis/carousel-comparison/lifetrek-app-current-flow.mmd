graph TB
    subgraph "Request Handling"
        A[HTTP Request] --> B{Job Mode?}
        B -->|Async| C[Load Job from DB]
        B -->|Sync| D[Extract Request Body]
        C --> E[Update Job Status: Processing]
        D --> F[Parse Parameters]
        E --> F
    end

    subgraph "Configuration"
        F --> G[Load GCP Config]
        G --> H[GCP_PROJECT_ID]
        G --> I[GCP_REGION]
        G --> J[VERTEX_API_KEY]
        G --> K[GOOGLE_DRIVE_FOLDER_ID]
    end

    subgraph "Content Generation - MOCK"
        F --> L{Action Type}
        L -->|regenerate_images| M[Use Existing Slides]
        L -->|generate| N[MOCK Text Generation]
        N --> O[Hardcoded Slides Array]
        O --> P["Hook: The Secret to Efficiency"]
        O --> Q["Content: Step 1 Automate"]
        O --> R["Content: Step 2 Delegate"]
        O --> S["CTA: Ready to Scale?"]
        M --> T[Carousel Object]
        P --> T
        Q --> T
        R --> T
        S --> T
    end

    subgraph "Stage 1: Background Generation"
        T --> U[Image Generation Loop]
        U --> V{Existing Image?}
        V -->|Yes| W[Use Existing]
        V -->|No| X[Build Image Prompt]
        X --> Y[System Prompt: NO TEXT RULE]
        Y --> Z[Brand Guidelines]
        Z --> AA[Corporate Blue #004F8F]
        Z --> AB[Innovation Green #1A7A3E]
        Z --> AC[Negative Space for Text]
        AA --> AD[Vertex AI Call]
        AB --> AD
        AC --> AD
        AD --> AE[imagegeneration@006]
        AE --> AF{Success?}
        AF -->|Yes| AG[Base64 Image URL]
        AF -->|No| AH[Error String]
        W --> AI[Image URLs Array]
        AG --> AI
        AH --> AI
    end

    subgraph "Stage 2: Satori Branding - ENABLED"
        AI --> AJ[Branding Overlay Loop]
        AJ --> AK[Load Fonts: Roboto]
        AK --> AL[Fetch Logo from Storage]
        AL --> AM[Fetch ISO Badge]
        AM --> AN{Assets Loaded?}
        AN -->|No| AO[Skip Overlay - Return Background]
        AN -->|Yes| AP[Build Satori Markup]
        AP --> AQ[Background Image Layer]
        AQ --> AR[Light Tint Overlay 40%→10%]
        AR --> AS[Text Content Block]
        AS --> AT["Headline: 64px Bold"]
        AS --> AU["Body: 32px Regular"]
        AS --> AV[Heavy Text Shadow]
        AR --> AW[Footer Branding]
        AW --> AX[Logo Left]
        AW --> AY[ISO Badge Right]
        AT --> AZ[Satori Render]
        AU --> AZ
        AV --> AZ
        AX --> AZ
        AY --> AZ
        AZ --> BA[HTML/CSS → SVG]
        BA --> BB[Resvg: SVG → PNG]
        BB --> BC[Base64 Branded Image]
        AO --> BD[Final Image URLs]
        BC --> BD
    end

    subgraph "Stage 3: Google Drive Upload - OPTIONAL"
        BD --> BE{Drive Configured?}
        BE -->|No| BF[Skip Upload - Warning]
        BE -->|Yes| BG[Create Timestamp Folder]
        BG --> BH[Clean Topic Name]
        BH --> BI[Create Subfolder]
        BI --> BJ[Upload Loop]
        BJ --> BK{Valid Image?}
        BK -->|Error| BL[Skip Slide]
        BK -->|Valid| BM[Decode Base64]
        BM --> BN[Convert to Bytes]
        BN --> BO[Upload to Drive]
        BO --> BP[slide_N.png]
        BL --> BQ[Upload Complete]
        BP --> BQ
        BF --> BQ
    end

    subgraph "Response Handling"
        BQ --> BR[Build Result Object]
        BR --> BS[carousel + imageUrls]
        BS --> BT{Job Mode?}
        BT -->|Async| BU[Update Job: Completed]
        BT -->|Sync| BV[Return JSON Response]
        BU --> BW[Return 200 OK]
        BV --> BW
    end

    subgraph "Error Handling"
        BX[Any Stage Error] --> BY{Job Mode?}
        BY -->|Async| BZ[Update Job: Failed]
        BY -->|Sync| CA[Return 500 Error]
        BZ --> CB[Log Error]
        CA --> CB
    end

    style N fill:#E74C3C
    style O fill:#E74C3C
    style Y fill:#F39C12
    style AE fill:#1A7A3E
    style AJ fill:#4A90E2
    style AZ fill:#9B59B6
    style BO fill:#27AE60
    style BX fill:#E74C3C
