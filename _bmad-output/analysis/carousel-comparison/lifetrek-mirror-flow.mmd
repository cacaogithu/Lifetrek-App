graph TB
    subgraph "Frontend - LinkedInCarousel.tsx"
        A[User Input Form] --> B{Generation Mode}
        B -->|Single| C[Single Carousel Request]
        B -->|Batch| D[Batch Carousel Request]
        B -->|Plan Mode| E[3 Strategic Variants]
    end

    subgraph "Edge Function - generate-linkedin-carousel"
        C --> F[Load System Prompt]
        D --> F
        E --> F
        F --> G[Fetch RAG Context]
        G --> H[Content Assets]
        G --> I[Company Assets]
        G --> J[Product Images]
        H --> K[Construct System Prompt]
        I --> K
        J --> K
        K --> L[Call AI - Gemini 2.5 Flash]
        L --> M{Tool Call Response}
    end

    subgraph "Multi-Agent System - agents.ts"
        M --> N[Strategist Agent]
        N --> O[Query Knowledge Base]
        N --> P[Search Industry Data]
        N --> Q[List Product Categories]
        O --> R[Strategic Plan Created]
        P --> R
        Q --> R
        R --> S[Copywriter Agent]
        S --> T[Get Hook Examples]
        S --> U[Query Brand Voice]
        T --> V[Copy Refined]
        U --> V
        V --> W[Designer Agent]
        W --> X[Search Real Assets]
        W --> Y[Search Products]
        X --> Z{Asset Found?}
        Y --> Z
        Z -->|Yes| AA[Use Real Asset]
        Z -->|No| AB[Generate AI Image]
    end

    subgraph "Critique Loop"
        AA --> AC[Brand Analyst Review]
        AB --> AC
        AC --> AD{Passes Brand Check?}
        AD -->|No| AE[Refine Content]
        AE --> S
        AD -->|Yes| AF[Approved Content]
    end

    subgraph "Image Generation"
        AF --> AG{Want Images?}
        AG -->|Yes| AH[Image Generation Loop]
        AG -->|No| AI[Text Only]
        AH --> AJ[Gemini 3 Pro Image]
        AJ --> AK[Generate with Prompt]
        AK --> AL[Image URL Generated]
    end

    subgraph "Storage & Response"
        AL --> AM[Auto-save to DB]
        AI --> AM
        AM --> AN[linkedin_carousels table]
        AN --> AO[Return to Frontend]
        AO --> AP[Display in UI]
        AP --> AQ[User Actions]
        AQ --> AR[Download ZIP/PDF]
        AQ --> AS[Regenerate Images]
        AQ --> AT[Save as Favorite]
    end

    style N fill:#4A90E2
    style S fill:#4A90E2
    style W fill:#4A90E2
    style AC fill:#F07818
    style AJ fill:#1A7A3E
